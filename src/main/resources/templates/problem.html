<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¬¸ì œ í’€ì´</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: #f5f5f5;
            padding: 20px 0;
        }
        .problem-container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .problem-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        .problem-number {
            font-size: 1.2rem;
            font-weight: bold;
            color: #667eea;
        }
        .problem-question {
            font-size: 1.3rem;
            line-height: 1.8;
            margin-bottom: 30px;
            white-space: pre-wrap;
        }
        .choice-option {
            padding: 15px 20px;
            margin-bottom: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .choice-option:hover {
            border-color: #667eea;
            background: #f0f0ff;
        }
        .choice-option.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }
        .answer-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            resize: vertical;
        }
        .answer-input:focus {
            border-color: #667eea;
            outline: none;
        }
        .btn-submit {
            width: 100%;
            padding: 15px;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 10px;
        }
        .result-modal .modal-body {
            padding: 30px;
        }
        .result-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }
        .result-correct {
            color: #28a745;
        }
        .result-incorrect {
            color: #dc3545;
        }
        .ai-feedback {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 20px;
            border-radius: 5px;
            margin-top: 20px;
            white-space: pre-wrap;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .loading.active {
            display: block;
        }
    </style>
</head>
<body>
<div class="problem-container">
    <!-- Problem Header -->
    <div class="problem-header">
        <div class="problem-number" id="problemNumber">ë¬¸ì œ 1/10</div>
        <div>
            <span class="badge bg-primary me-2" id="categoryBadge">Spring Core</span>
            <span class="badge bg-warning" id="difficultyBadge">ì¤‘ê¸‰</span>
            <span class="badge bg-info" id="typeBadge">ê°ê´€ì‹</span>
        </div>
    </div>

    <!-- Question -->
    <div class="problem-question" id="problemQuestion">
        ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
    </div>

    <!-- Answer Area -->
    <div id="answerArea">
        <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
    </div>

    <!-- Loading -->
    <div class="loading" id="loading">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-3">ì±„ì  ì¤‘ì…ë‹ˆë‹¤...</p>
    </div>

    <!-- Buttons -->
    <div class="d-flex justify-content-between mt-4">
        <button class="btn btn-outline-secondary" onclick="goBack()">â† ë’¤ë¡œê°€ê¸°</button>
        <button class="btn btn-primary btn-submit" onclick="submitAnswer()">ì œì¶œí•˜ê¸° â†’</button>
    </div>
</div>

<!-- Result Modal -->
<div class="modal fade" id="resultModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ì±„ì  ê²°ê³¼</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <div class="result-icon" id="resultIcon">âœ“</div>
                    <h3 id="resultTitle">ì •ë‹µì…ë‹ˆë‹¤!</h3>
                    <p class="text-muted" id="resultScore">ì ìˆ˜: 100ì </p>
                </div>

                <div class="mt-4">
                    <h6 class="fw-bold">ğŸ“ í•´ì„¤</h6>
                    <p id="resultExplanation" class="mb-0"></p>
                </div>

                <div class="ai-feedback" id="aiFeedback" style="display:none;">
                    <h6 class="fw-bold mb-3">ğŸ¤– AI í”¼ë“œë°±</h6>
                    <div id="aiFeedbackContent"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                <button type="button" class="btn btn-primary" onclick="nextProblem()">ë‹¤ìŒ ë¬¸ì œ â†’</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let problems = [];
    let currentIndex = 0;
    let currentProblem = null;
    let selectedAnswer = '';
    let resultModal;

    // URL íŒŒë¼ë¯¸í„° íŒŒì‹±
    const urlParams = new URLSearchParams(window.location.search);
    const category = urlParams.get('category');
    const difficulty = urlParams.get('difficulty');
    const mode = urlParams.get('mode') || 'free';

    document.addEventListener('DOMContentLoaded', function() {
        resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
        loadProblems();
    });

    async function loadProblems() {
        try {
            const response = await fetch(`/api/problems?category=${category}&difficulty=${difficulty}`);

            if (!response.ok) {
                throw new Error('ë¬¸ì œ ë¡œë“œ ì‹¤íŒ¨');
            }

            problems = await response.json();

            if (problems.length === 0) {
                alert('í•´ë‹¹ ì¡°ê±´ì˜ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.');
                goBack();
                return;
            }

            // ì±Œë¦°ì§€ ëª¨ë“œë©´ ëœë¤ 10ê°œ ì„ íƒ
            if (mode === 'challenge' && problems.length > 10) {
                problems = problems.sort(() => Math.random() - 0.5).slice(0, 10);
            }

            displayProblem(0);
        } catch (error) {
            console.error('ë¬¸ì œ ë¡œë“œ ì˜¤ë¥˜:', error);
            alert('ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            goBack();
        }
    }

    function displayProblem(index) {
        if (index >= problems.length) {
            alert('ëª¨ë“  ë¬¸ì œë¥¼ í’€ì—ˆìŠµë‹ˆë‹¤! ğŸ‰');
            goBack();
            return;
        }

        currentIndex = index;
        currentProblem = problems[index];
        selectedAnswer = '';

        // Header ì—…ë°ì´íŠ¸
        document.getElementById('problemNumber').textContent = `ë¬¸ì œ ${index + 1}/${problems.length}`;
        document.getElementById('categoryBadge').textContent = getCategoryName(currentProblem.category);
        document.getElementById('difficultyBadge').textContent = getDifficultyName(currentProblem.difficulty);
        document.getElementById('typeBadge').textContent = getTypeName(currentProblem.problemType);

        // Question í‘œì‹œ
        document.getElementById('problemQuestion').textContent = currentProblem.question;

        // Answer Area ìƒì„±
        const answerArea = document.getElementById('answerArea');
        answerArea.innerHTML = '';

        if (currentProblem.problemType === 'MULTIPLE_CHOICE' && currentProblem.choices) {
            // ê°ê´€ì‹
            currentProblem.choices.forEach((choice) => {
                const choiceDiv = document.createElement('div');
                choiceDiv.className = 'choice-option';
                choiceDiv.textContent = choice;
                choiceDiv.onclick = () => selectChoice(choice, choiceDiv);
                answerArea.appendChild(choiceDiv);
            });
        } else {
            // ì£¼ê´€ì‹
            const textarea = document.createElement('textarea');
            textarea.className = 'answer-input';
            textarea.rows = currentProblem.problemType === 'DESCRIPTIVE' ? 8 : 3;
            textarea.placeholder = 'ë‹µì•ˆì„ ì…ë ¥í•˜ì„¸ìš”...';
            textarea.oninput = (e) => selectedAnswer = e.target.value;
            answerArea.appendChild(textarea);
        }
    }

    function selectChoice(choice, element) {
        // ì´ì „ ì„ íƒ í•´ì œ
        document.querySelectorAll('.choice-option').forEach(el => {
            el.classList.remove('selected');
        });
        // í˜„ì¬ ì„ íƒ
        element.classList.add('selected');
        selectedAnswer = choice;
    }

    async function submitAnswer() {
        if (!selectedAnswer.trim()) {
            alert('ë‹µì•ˆì„ ì„ íƒí•˜ê±°ë‚˜ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        // ë¡œë”© í‘œì‹œ
        document.getElementById('loading').classList.add('active');
        document.querySelector('.btn-submit').disabled = true;

        try {
            const response = await fetch('/api/problems/submit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    problemId: currentProblem.id,
                    userAnswer: selectedAnswer
                })
            });

            if (!response.ok) {
                throw new Error('ë‹µì•ˆ ì œì¶œ ì‹¤íŒ¨');
            }

            const result = await response.json();
            showResult(result);
        } catch (error) {
            console.error('ë‹µì•ˆ ì œì¶œ ì˜¤ë¥˜:', error);
            alert('ë‹µì•ˆ ì œì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        } finally {
            document.getElementById('loading').classList.remove('active');
            document.querySelector('.btn-submit').disabled = false;
        }
    }

    function showResult(result) {
        const resultIcon = document.getElementById('resultIcon');
        const resultTitle = document.getElementById('resultTitle');
        const resultScore = document.getElementById('resultScore');
        const resultExplanation = document.getElementById('resultExplanation');
        const aiFeedback = document.getElementById('aiFeedback');
        const aiFeedbackContent = document.getElementById('aiFeedbackContent');

        // ì •ë‹µ ì—¬ë¶€ì— ë”°ë¼ í‘œì‹œ
        if (result.isCorrect) {
            resultIcon.textContent = 'âœ“';
            resultIcon.className = 'result-icon result-correct';
            resultTitle.textContent = 'ì •ë‹µì…ë‹ˆë‹¤! ğŸ‰';
        } else {
            resultIcon.textContent = 'âœ—';
            resultIcon.className = 'result-icon result-incorrect';
            resultTitle.textContent = 'ì•„ì‰½ê²Œë„ ì˜¤ë‹µì…ë‹ˆë‹¤';
        }

        resultScore.textContent = `ì ìˆ˜: ${result.score}ì `;
        resultExplanation.textContent = currentProblem.explanation || 'í•´ì„¤ì´ ì—†ìŠµë‹ˆë‹¤.';

        // AI í”¼ë“œë°± í‘œì‹œ
        if (result.aiFeedback) {
            aiFeedback.style.display = 'block';
            aiFeedbackContent.textContent = result.aiFeedback;
        } else {
            aiFeedback.style.display = 'none';
        }

        resultModal.show();
    }

    function nextProblem() {
        resultModal.hide();
        displayProblem(currentIndex + 1);
    }

    function goBack() {
        if (mode === 'challenge') {
            location.href = '/';
        } else {
            location.href = '/category';
        }
    }

    // Helper functions
    function getCategoryName(category) {
        const names = {
            'SPRING_CORE': 'Spring Core',
            'SPRING_BOOT': 'Spring Boot',
            'SPRING_MVC': 'Spring MVC',
            'SPRING_DATA_JPA': 'Spring Data JPA',
            'SPRING_SECURITY': 'Spring Security'
        };
        return names[category] || category;
    }

    function getDifficultyName(difficulty) {
        const names = {
            'BEGINNER': 'ì´ˆê¸‰',
            'INTERMEDIATE': 'ì¤‘ê¸‰',
            'ADVANCED': 'ê³ ê¸‰'
        };
        return names[difficulty] || difficulty;
    }

    function getTypeName(type) {
        const names = {
            'MULTIPLE_CHOICE': 'ê°ê´€ì‹',
            'SHORT_ANSWER': 'ë‹¨ë‹µí˜•',
            'DESCRIPTIVE': 'ì„œìˆ í˜•'
        };
        return names[type] || type;
    }
</script>
</body>
</html>