<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê´€ë¦¬ì í˜ì´ì§€ - Spring Quiz</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #f5f5f5;
      padding-top: 60px;
    }
    .admin-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px 0;
      margin-bottom: 30px;
    }
    .stat-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      transition: transform 0.3s;
    }
    .stat-card:hover {
      transform: translateY(-5px);
    }
    .stat-number {
      font-size: 2.5rem;
      font-weight: bold;
    }
    .stat-label {
      color: #666;
      font-size: 0.9rem;
    }
    .table-card {
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .btn-action {
      padding: 5px 15px;
      border-radius: 5px;
      font-size: 0.85rem;
    }
    .navbar-custom {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
<!-- Navbar -->
<nav class="navbar navbar-custom navbar-expand-lg navbar-light">
  <div class="container">
    <a class="navbar-brand fw-bold" href="/">â˜• Spring Quiz</a>
    <div class="navbar-nav ms-auto">
      <span class="navbar-text me-3">ğŸ‘¤ <span id="adminName">ê´€ë¦¬ì</span></span>
      <button class="btn btn-outline-danger btn-sm" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </div>
</nav>

<div class="container">
  <!-- Header -->
  <div class="admin-header text-center">
    <h1 class="mb-2">ğŸ› ï¸ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
    <p class="mb-0">ì‹œìŠ¤í…œ ì „ì²´ ê´€ë¦¬ ë° í†µê³„</p>
  </div>

  <!-- Statistics Cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="stat-card">
        <div class="stat-number text-primary" id="totalUsers">0</div>
        <div class="stat-label">ì „ì²´ ì‚¬ìš©ì</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card">
        <div class="stat-number text-success" id="totalProblems">100</div>
        <div class="stat-label">ì „ì²´ ë¬¸ì œ</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card">
        <div class="stat-number text-warning" id="totalSolved">0</div>
        <div class="stat-label">ì´ í’€ì´ ìˆ˜</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card">
        <div class="stat-number text-danger" id="totalSessions">0</div>
        <div class="stat-label">ì±Œë¦°ì§€ ì„¸ì…˜</div>
      </div>
    </div>
  </div>

  <!-- User Management -->
  <div class="table-card mb-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h4 class="mb-0">ğŸ‘¥ ì‚¬ìš©ì ê´€ë¦¬</h4>
      <button class="btn btn-primary" onclick="refreshUsers()">ìƒˆë¡œê³ ì¹¨</button>
    </div>
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
        <tr>
          <th>ID</th>
          <th>ì•„ì´ë””</th>
          <th>í•™êµ</th>
          <th>ì—­í• </th>
          <th>ê°€ì…ì¼</th>
          <th>ì‘ì—…</th>
        </tr>
        </thead>
        <tbody id="userTableBody">
        <tr>
          <td colspan="6" class="text-center text-muted">ë¡œë”© ì¤‘...</td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>

    <!-- Problem Management -->
    <div class="table-card mb-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="mb-0">ğŸ“ ë¬¸ì œ ê´€ë¦¬</h4>
            <button class="btn btn-success" onclick="showCreateProblemModal()">â• ìƒˆ ë¬¸ì œ ì¶”ê°€</button>
        </div>
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>ì¹´í…Œê³ ë¦¬</th>
                    <th>ë‚œì´ë„</th>
                    <th>ìœ í˜•</th>
                    <th>ì§ˆë¬¸ (ë¯¸ë¦¬ë³´ê¸°)</th>
                    <th>ì‘ì—…</th>
                </tr>
                </thead>
                <tbody id="problemTableBody">
                <tr>
                    <td colspan="6" class="text-center text-muted">ë¡œë”© ì¤‘...</td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
        <nav>
            <ul class="pagination justify-content-center" id="problemPagination">
            </ul>
        </nav>
    </div>

  <!-- Problem Statistics by Category -->
  <div class="table-card">
    <h4 class="mb-4">ğŸ“Š ì¹´í…Œê³ ë¦¬ë³„ ë¬¸ì œ í†µê³„</h4>
    <div class="row">
      <div class="col-md-6 mb-3">
        <div class="p-3 border rounded">
          <h6>ğŸ”§ Spring Core</h6>
          <div class="d-flex justify-content-between">
            <span>ì´ˆê¸‰: <strong>6ê°œ</strong></span>
            <span>ì¤‘ê¸‰: <strong>7ê°œ</strong></span>
            <span>ê³ ê¸‰: <strong>7ê°œ</strong></span>
          </div>
        </div>
      </div>
      <div class="col-md-6 mb-3">
        <div class="p-3 border rounded">
          <h6>âš¡ Spring Boot</h6>
          <div class="d-flex justify-content-between">
            <span>ì´ˆê¸‰: <strong>6ê°œ</strong></span>
            <span>ì¤‘ê¸‰: <strong>7ê°œ</strong></span>
            <span>ê³ ê¸‰: <strong>7ê°œ</strong></span>
          </div>
        </div>
      </div>
      <div class="col-md-6 mb-3">
        <div class="p-3 border rounded">
          <h6>ğŸŒ Spring MVC</h6>
          <div class="d-flex justify-content-between">
            <span>ì´ˆê¸‰: <strong>3ê°œ</strong></span>
            <span>ì¤‘ê¸‰: <strong>4ê°œ</strong></span>
            <span>ê³ ê¸‰: <strong>3ê°œ</strong></span>
          </div>
        </div>
      </div>
      <div class="col-md-6 mb-3">
        <div class="p-3 border rounded">
          <h6>ğŸ’¾ Spring Data JPA</h6>
          <div class="d-flex justify-content-between">
            <span>ì´ˆê¸‰: <strong>6ê°œ</strong></span>
            <span>ì¤‘ê¸‰: <strong>7ê°œ</strong></span>
            <span>ê³ ê¸‰: <strong>7ê°œ</strong></span>
          </div>
        </div>
      </div>
      <div class="col-md-6 mb-3">
        <div class="p-3 border rounded">
          <h6>ğŸ”’ Spring Security</h6>
          <div class="d-flex justify-content-between">
            <span>ì´ˆê¸‰: <strong>3ê°œ</strong></span>
            <span>ì¤‘ê¸‰: <strong>4ê°œ</strong></span>
            <span>ê³ ê¸‰: <strong>3ê°œ</strong></span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Create Problem Modal -->
<div class="modal fade" id="createProblemModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ìƒˆ ë¬¸ì œ ì¶”ê°€</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createProblemForm">
                    <div class="mb-3">
                        <label class="form-label">ìœ í˜•</label>
                        <select class="form-select" id="problemType" required>
                            <option value="MULTIPLE_CHOICE">ê°ê´€ì‹</option>
                            <option value="SHORT_ANSWER">ë‹¨ë‹µí˜•</option>
                            <option value="DESCRIPTIVE">ì„œìˆ í˜•</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">ì¹´í…Œê³ ë¦¬</label>
                        <select class="form-select" id="category" required>
                            <option value="SPRING_CORE">Spring Core</option>
                            <option value="SPRING_BOOT">Spring Boot</option>
                            <option value="SPRING_MVC">Spring MVC</option>
                            <option value="SPRING_DATA_JPA">Spring Data JPA</option>
                            <option value="SPRING_SECURITY">Spring Security</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">ë‚œì´ë„</label>
                        <select class="form-select" id="difficulty" required>
                            <option value="BEGINNER">ì´ˆê¸‰</option>
                            <option value="INTERMEDIATE">ì¤‘ê¸‰</option>
                            <option value="ADVANCED">ê³ ê¸‰</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">ì§ˆë¬¸</label>
                        <textarea class="form-control" id="question" rows="3" required></textarea>
                    </div>

                    <div class="mb-3" id="choicesSection">
                        <label class="form-label">ì„ íƒì§€ (ê°ê´€ì‹ì¸ ê²½ìš°, ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„)</label>
                        <textarea class="form-control" id="choices" rows="4"
                                  placeholder="ì˜ˆ:\nì„ íƒì§€1\nì„ íƒì§€2\nì„ íƒì§€3\nì„ íƒì§€4"></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">ì •ë‹µ</label>
                        <input type="text" class="form-control" id="answer" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">í•´ì„¤</label>
                        <textarea class="form-control" id="explanation" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" onclick="createProblem()">ìƒì„±</button>
            </div>
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let createProblemModal;
    let currentPage = 0;
    let totalPages = 0;

    document.addEventListener('DOMContentLoaded', function() {
        createProblemModal = new bootstrap.Modal(document.getElementById('createProblemModal'));
        loadProblems();

        // ë¬¸ì œ ìœ í˜•ì— ë”°ë¼ ì„ íƒì§€ ì…ë ¥ë€ í‘œì‹œ/ìˆ¨ê¹€
        document.getElementById('problemType').addEventListener('change', function() {
            const choicesSection = document.getElementById('choicesSection');
            choicesSection.style.display = this.value === 'MULTIPLE_CHOICE' ? 'block' : 'none';
        });
    });

    async function loadProblems(page = 0) {
        const accessToken = localStorage.getItem('access_token');

        try {
            const response = await fetch(`/api/admin/problems?page=${page}&size=10`, {
                headers: {
                    'Authorization': 'Bearer ' + accessToken
                }
            });

            if (!response.ok) {
                handleAuthError(response.status);
                return;
            }

            const data = await response.json();
            displayProblems(data.problems);
            displayPagination(data);

        } catch (error) {
            console.error('ë¬¸ì œ ë¡œë“œ ì˜¤ë¥˜:', error);
        }
    }

    function displayProblems(problems) {
        const tbody = document.getElementById('problemTableBody');

        if (problems.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
            return;
        }

        tbody.innerHTML = problems.map(p => `
        <tr>
            <td>${p.id}</td>
            <td><span class="badge bg-info">${getCategoryName(p.category)}</span></td>
            <td><span class="badge bg-${getDifficultyColor(p.difficulty)}">${getDifficultyName(p.difficulty)}</span></td>
            <td>${getTypeName(p.problemType)}</td>
            <td>${p.question.substring(0, 50)}...</td>
            <td>
                <button class="btn btn-sm btn-outline-warning btn-action" onclick="editProblem(${p.id})">
                    ìˆ˜ì •
                </button>
                <button class="btn btn-sm btn-outline-danger btn-action" onclick="deleteProblem(${p.id})">
                    ì‚­ì œ
                </button>
            </td>
        </tr>
    `).join('');
    }

    function displayPagination(data) {
        currentPage = data.currentPage;
        totalPages = data.totalPages;

        const pagination = document.getElementById('problemPagination');
        let html = '';

        // ì´ì „ ë²„íŠ¼
        html += `<li class="page-item ${!data.hasPrevious ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="loadProblems(${currentPage - 1}); return false;">ì´ì „</a>
    </li>`;

        // í˜ì´ì§€ ë²ˆí˜¸
        for (let i = 0; i < totalPages; i++) {
            html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" href="#" onclick="loadProblems(${i}); return false;">${i + 1}</a>
        </li>`;
        }

        // ë‹¤ìŒ ë²„íŠ¼
        html += `<li class="page-item ${!data.hasNext ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="loadProblems(${currentPage + 1}); return false;">ë‹¤ìŒ</a>
    </li>`;

        pagination.innerHTML = html;
    }

    function showCreateProblemModal() {
        document.getElementById('createProblemForm').reset();
        createProblemModal.show();
    }

    async function createProblem() {
        const problemType = document.getElementById('problemType').value;
        const category = document.getElementById('category').value;
        const difficulty = document.getElementById('difficulty').value;
        const question = document.getElementById('question').value;
        const answer = document.getElementById('answer').value;
        const explanation = document.getElementById('explanation').value;

        // ì„ íƒì§€ ì²˜ë¦¬
        let choices = null;
        if (problemType === 'MULTIPLE_CHOICE') {
            const choicesText = document.getElementById('choices').value;
            choices = choicesText.split('\n').filter(c => c.trim());
        }

        const accessToken = localStorage.getItem('access_token');

        try {
            const response = await fetch('/api/admin/problems', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + accessToken
                },
                body: JSON.stringify({
                    problemType,
                    category,
                    difficulty,
                    question,
                    choices,
                    answer,
                    explanation
                })
            });

            if (!response.ok) {
                throw new Error('ë¬¸ì œ ìƒì„± ì‹¤íŒ¨');
            }

            alert('ë¬¸ì œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
            createProblemModal.hide();
            loadProblems();

        } catch (error) {
            console.error('ë¬¸ì œ ìƒì„± ì˜¤ë¥˜:', error);
            alert('ë¬¸ì œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    async function deleteProblem(problemId) {
        if (!confirm('ì •ë§ ì´ ë¬¸ì œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            return;
        }

        const accessToken = localStorage.getItem('access_token');

        try {
            const response = await fetch(`/api/admin/problems/${problemId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': 'Bearer ' + accessToken
                }
            });

            if (!response.ok) {
                throw new Error('ë¬¸ì œ ì‚­ì œ ì‹¤íŒ¨');
            }

            const result = await response.json();
            alert(result.message);
            loadProblems(currentPage);

        } catch (error) {
            console.error('ë¬¸ì œ ì‚­ì œ ì˜¤ë¥˜:', error);
            alert('ë¬¸ì œ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    function editProblem(problemId) {
        // TODO: ìˆ˜ì • ëª¨ë‹¬ êµ¬í˜„
        alert(`ë¬¸ì œ ${problemId} ìˆ˜ì • ê¸°ëŠ¥ (êµ¬í˜„ ì˜ˆì •)`);
    }

    function getCategoryName(category) {
        const names = {
            'SPRING_CORE': 'Spring Core',
            'SPRING_BOOT': 'Spring Boot',
            'SPRING_MVC': 'Spring MVC',
            'SPRING_DATA_JPA': 'Spring Data JPA',
            'SPRING_SECURITY': 'Spring Security'
        };
        return names[category] || category;
    }

    function getDifficultyName(difficulty) {
        const names = {
            'BEGINNER': 'ì´ˆê¸‰',
            'INTERMEDIATE': 'ì¤‘ê¸‰',
            'ADVANCED': 'ê³ ê¸‰'
        };
        return names[difficulty] || difficulty;
    }

    function getDifficultyColor(difficulty) {
        const colors = {
            'BEGINNER': 'success',
            'INTERMEDIATE': 'warning',
            'ADVANCED': 'danger'
        };
        return colors[difficulty] || 'secondary';
    }

    function getTypeName(type) {
        const names = {
            'MULTIPLE_CHOICE': 'ê°ê´€ì‹',
            'SHORT_ANSWER': 'ë‹¨ë‹µí˜•',
            'DESCRIPTIVE': 'ì„œìˆ í˜•'
        };
        return names[type] || type;
    }

    function checkAdminAuth() {
        const accessToken = localStorage.getItem('access_token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        if (!accessToken) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ í˜ì´ì§€ì…ë‹ˆë‹¤.');
            window.location.href = '/login';
            return false;
        }

        if (user.role !== 'ROLE_ADMIN') {
            alert('ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = '/';
            return false;
        }

        document.getElementById('adminName').textContent = user.loginId || 'ê´€ë¦¬ì';
        return true;
    }

    if (!checkAdminAuth()) {
        throw new Error('Admin authentication required');
    }

    // ========== ëŒ€ì‹œë³´ë“œ í†µê³„ ë¡œë“œ ==========
    async function loadDashboard() {
        const accessToken = localStorage.getItem('access_token');

        try {
            const response = await fetch('/api/admin/dashboard', {
                headers: {
                    'Authorization': 'Bearer ' + accessToken
                }
            });

            if (!response.ok) {
                handleAuthError(response.status);
                return;
            }

            const data = await response.json();

            // í†µê³„ í‘œì‹œ
            document.getElementById('totalUsers').textContent = data.totalUsers || 0;
            document.getElementById('totalProblems').textContent = data.totalProblems || 0;

        } catch (error) {
            console.error('ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
    }

    // ========== ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ ==========
    async function loadUsers() {
        const accessToken = localStorage.getItem('access_token');

        try {
            const response = await fetch('/api/admin/users', {
                headers: {
                    'Authorization': 'Bearer ' + accessToken
                }
            });

            if (!response.ok) {
                handleAuthError(response.status);
                return;
            }

            const users = await response.json();
            displayUsers(users);

        } catch (error) {
            console.error('ì‚¬ìš©ì ë¡œë“œ ì˜¤ë¥˜:', error);
            document.getElementById('userTableBody').innerHTML =
                '<tr><td colspan="6" class="text-center text-danger">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</td></tr>';
        }
    }

    function displayUsers(users) {
        const tbody = document.getElementById('userTableBody');

        if (users.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
            return;
        }

        tbody.innerHTML = users.map(user => `
        <tr>
            <td>${user.userId}</td>
            <td><strong>${user.loginId}</strong></td>
            <td>${user.nickname || '-'}</td>
            <td>
                <span class="badge ${user.role === 'ROLE_ADMIN' ? 'bg-danger' : 'bg-primary'}">
                    ${user.role === 'ROLE_ADMIN' ? 'ê´€ë¦¬ì' : 'ì‚¬ìš©ì'}
                </span>
            </td>
            <td>${formatDate(user.createdAt)}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary btn-action" onclick="viewUser(${user.userId})">
                    ìƒì„¸
                </button>
                <button class="btn btn-sm btn-outline-danger btn-action" onclick="deleteUser(${user.userId})">
                    ì‚­ì œ
                </button>
            </td>
        </tr>
    `).join('');
    }

    // ========== ì‚¬ìš©ì ê´€ë¦¬ ==========
    function viewUser(userId) {
        window.location.href = `/admin/users/${userId}`;
    }

    async function deleteUser(userId) {
        if (!confirm('ì •ë§ ì´ ì‚¬ìš©ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            return;
        }

        const accessToken = localStorage.getItem('access_token');

        try {
            const response = await fetch(`/api/admin/users/${userId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': 'Bearer ' + accessToken
                }
            });

            if (!response.ok) {
                handleAuthError(response.status);
                return;
            }

            const result = await response.json();
            alert(result.message);
            loadUsers(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨

        } catch (error) {
            console.error('ì‚¬ìš©ì ì‚­ì œ ì˜¤ë¥˜:', error);
            alert('ì‚¬ìš©ì ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ========== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ==========
    function formatDate(dateString) {
        if (!dateString) return '-';
        const date = new Date(dateString);
        return date.toLocaleDateString('ko-KR');
    }

    function handleAuthError(status) {
        if (status === 401) {
            alert('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
            localStorage.clear();
            window.location.href = '/login';
        } else if (status === 403) {
            alert('ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
            window.location.href = '/';
        }
    }

    function refreshUsers() {
        loadUsers();
    }

    function logout() {
        if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            localStorage.clear();
            window.location.href = '/';
        }
    }

    // ========== í˜ì´ì§€ ì´ˆê¸°í™” ==========
    document.addEventListener('DOMContentLoaded', function() {
        loadDashboard();
        loadUsers();
    });
</script>
</body>
</html>