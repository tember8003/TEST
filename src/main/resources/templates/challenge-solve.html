<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ï±åÎ¶∞ÏßÄ ÌíÄÏù¥</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: #f5f5f5;
            padding-bottom: 50px;
        }
        .challenge-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .timer {
            font-size: 1.5rem;
            font-weight: bold;
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
        }
        .timer.warning {
            background: rgba(255,193,7,0.3);
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .progress-tracker {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }
        .progress-dot {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }
        .progress-dot.current {
            background: #ffc107;
            transform: scale(1.2);
        }
        .progress-dot.correct {
            background: #28a745;
            color: white;
        }
        .progress-dot.incorrect {
            background: #dc3545;
            color: white;
        }
        .problem-container {
            max-width: 900px;
            margin: 20px auto;
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .problem-question {
            font-size: 1.3rem;
            line-height: 1.8;
            margin-bottom: 30px;
            white-space: pre-wrap;
        }
        .choice-option {
            padding: 15px 20px;
            margin-bottom: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .choice-option:hover {
            border-color: #667eea;
            background: #f0f0ff;
        }
        .choice-option.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }
        .answer-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            resize: vertical;
        }
        .btn-submit {
            width: 100%;
            padding: 15px;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 10px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
<!-- Ï±åÎ¶∞ÏßÄ Ìó§Îçî -->
<div class="challenge-header">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h4 class="mb-0">üèÜ Ï±åÎ¶∞ÏßÄ Î™®Îìú</h4>
                <small id="categoryInfo">Loading...</small>
            </div>
            <div class="timer" id="timer">--:--</div>
        </div>
        <div class="progress-tracker" id="progressTracker">
            <!-- ÏßÑÌñâÎèÑ Ï†êÎì§Ïù¥ ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±Îê® -->
        </div>
    </div>
</div>

<!-- Î¨∏Ï†ú ÏòÅÏó≠ -->
<div class="problem-container">
    <div class="mb-3">
        <span class="badge bg-primary" id="problemNumber">Î¨∏Ï†ú 1</span>
        <span class="badge bg-info" id="typeBadge">Í∞ùÍ¥ÄÏãù</span>
    </div>

    <div class="problem-question" id="problemQuestion">
        Î¨∏Ï†úÎ•º Î∂àÎü¨Ïò§Îäî Ï§ë...
    </div>

    <div id="answerArea">
        <!-- ÎãµÏïà ÏòÅÏó≠ -->
    </div>

    <button class="btn btn-primary btn-submit" onclick="submitAnswer()">
        Ï†úÏ∂úÌïòÍ∏∞ ‚Üí
    </button>
</div>

<!-- Í≤∞Í≥º Î™®Îã¨ -->
<div class="modal fade" id="resultModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resultTitle">Í≤∞Í≥º</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="resultBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="nextProblem()">Îã§Ïùå Î¨∏Ï†ú ‚Üí</button>
            </div>
        </div>
    </div>
</div>

<!-- ÏôÑÎ£å Î™®Îã¨ -->
<div class="modal fade" id="completeModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">üéâ Ï±åÎ¶∞ÏßÄ ÏôÑÎ£å!</h5>
            </div>
            <div class="modal-body" id="completeBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="location.href='/'">Î©îÏù∏ÏúºÎ°ú</button>
                <button type="button" class="btn btn-primary" onclick="location.href='/statistics'">ÌÜµÍ≥Ñ Î≥¥Í∏∞</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="/js/token.js"></script>
<script>
    let sessionId = null;
    let session = null;
    let problems = [];
    let currentIndex = 0;
    let selectedAnswer = '';
    let results = [];
    let timerInterval = null;
    let remainingSeconds = 0;

    const urlParams = new URLSearchParams(window.location.search);
    sessionId = urlParams.get('sessionId');

    async function loadSession() {
        try {
            // ÏÑ∏ÏÖò Ï†ïÎ≥¥ Î°úÎìú
            const sessionResponse = await fetch(`/api/sessions/${sessionId}`, {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                }
            });
            session = await sessionResponse.json();

            // Ïπ¥ÌÖåÍ≥†Î¶¨ Ï†ïÎ≥¥ ÌëúÏãú
            document.getElementById('categoryInfo').textContent =
                `${getCategoryName(session.category)} - ${getDifficultyName(session.difficulty)}`;

            // ÌÉÄÏù¥Î®∏ ÏãúÏûë
            if (session.timeLimitMinutes) {
                remainingSeconds = session.timeLimitMinutes * 60;
                startTimer();
            }

            // Î¨∏Ï†ú Î°úÎìú
            const problemsResponse = await fetch(`/api/sessions/${sessionId}/problems`, {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                }
            });
            problems = await problemsResponse.json();

            // ÏßÑÌñâÎèÑ Ìä∏ÎûòÏª§ ÏÉùÏÑ±
            createProgressTracker();

            // Ï≤´ Î¨∏Ï†ú ÌëúÏãú
            displayProblem(0);

        } catch (error) {
            console.error('ÏÑ∏ÏÖò Î°úÎìú Ïã§Ìå®:', error);
            alert('ÏÑ∏ÏÖòÏùÑ Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            location.href = '/challenge';
        }
    }

    function startTimer() {
        const timerElement = document.getElementById('timer');

        timerInterval = setInterval(() => {
            remainingSeconds--;

            const minutes = Math.floor(remainingSeconds / 60);
            const seconds = remainingSeconds % 60;
            timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

            // 3Î∂Ñ ÎÇ®ÏïòÏùÑ Îïå Í≤ΩÍ≥†
            if (remainingSeconds === 180) {
                timerElement.classList.add('warning');
            }

            // ÏãúÍ∞Ñ Ï¢ÖÎ£å
            if (remainingSeconds <= 0) {
                clearInterval(timerInterval);
                alert('ÏãúÍ∞ÑÏù¥ Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§!');
                completeChallenge();
            }
        }, 1000);
    }

    function createProgressTracker() {
        const tracker = document.getElementById('progressTracker');
        tracker.innerHTML = '';

        problems.forEach((_, index) => {
            const dot = document.createElement('div');
            dot.className = 'progress-dot';
            dot.textContent = index + 1;
            dot.id = `dot-${index}`;
            tracker.appendChild(dot);
        });

        document.getElementById('dot-0').classList.add('current');
    }

    function displayProblem(index) {
        currentIndex = index;
        const problem = problems[index];
        selectedAnswer = '';

        // Î¨∏Ï†ú Î≤àÌò∏
        document.getElementById('problemNumber').textContent = `Î¨∏Ï†ú ${index + 1}/${problems.length}`;
        document.getElementById('typeBadge').textContent = getTypeName(problem.problemType);

        // Î¨∏Ï†ú ÎÇ¥Ïö©
        document.getElementById('problemQuestion').textContent = problem.question;

        // ÎãµÏïà ÏòÅÏó≠
        const answerArea = document.getElementById('answerArea');
        answerArea.innerHTML = '';

        if (problem.problemType === 'MULTIPLE_CHOICE' && problem.choices) {
            problem.choices.forEach(choice => {
                const div = document.createElement('div');
                div.className = 'choice-option';
                div.textContent = choice;
                div.onclick = () => selectChoice(choice, div);
                answerArea.appendChild(div);
            });
        } else {
            const textarea = document.createElement('textarea');
            textarea.className = 'answer-input';
            textarea.rows = problem.problemType === 'DESCRIPTIVE' ? 8 : 3;
            textarea.placeholder = 'ÎãµÏïàÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî...';
            textarea.oninput = (e) => selectedAnswer = e.target.value;
            answerArea.appendChild(textarea);
        }

        // ÏßÑÌñâÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
        updateProgressTracker();
    }

    function selectChoice(choice, element) {
        document.querySelectorAll('.choice-option').forEach(el => {
            el.classList.remove('selected');
        });
        element.classList.add('selected');
        selectedAnswer = choice;
    }

    function updateProgressTracker() {
        document.querySelectorAll('.progress-dot').forEach(dot => {
            dot.classList.remove('current');
        });
        document.getElementById(`dot-${currentIndex}`).classList.add('current');
    }

    async function submitAnswer() {
        if (!selectedAnswer.trim()) {
            alert('ÎãµÏïàÏùÑ ÏÑ†ÌÉùÌïòÍ±∞ÎÇò ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
            return;
        }

        try {
            const response = await fetch(`/api/sessions/${sessionId}/submit`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                },
                body: JSON.stringify({
                    problemId: problems[currentIndex].id,
                    userAnswer: selectedAnswer
                })
            });

            const result = await response.json();
            results.push(result);

            // ÏßÑÌñâÎèÑ Ï†ê ÏÉâÏÉÅ Î≥ÄÍ≤Ω
            const dot = document.getElementById(`dot-${currentIndex}`);
            dot.classList.add(result.isCorrect ? 'correct' : 'incorrect');

            showResult(result);

        } catch (error) {
            console.error('ÎãµÏïà Ï†úÏ∂ú Ïã§Ìå®:', error);
            alert('ÎãµÏïà Ï†úÏ∂úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
        }
    }

    function showResult(result) {
        const modal = new bootstrap.Modal(document.getElementById('resultModal'));
        const title = document.getElementById('resultTitle');
        const body = document.getElementById('resultBody');

        title.innerHTML = result.isCorrect ? '‚úÖ Ï†ïÎãµÏûÖÎãàÎã§!' : '‚ùå Ïò§ÎãµÏûÖÎãàÎã§';
        title.className = result.isCorrect ? 'modal-title text-success' : 'modal-title text-danger';

        body.innerHTML = `
                <div class="mb-3">
                    <h6>Ï†êÏàò</h6>
                    <div class="progress">
                        <div class="progress-bar ${result.isCorrect ? 'bg-success' : 'bg-danger'}"
                             style="width: ${result.score}%">
                            ${result.score}Ï†ê
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <h6>AI ÌîºÎìúÎ∞±</h6>
                    <p class="text-muted" style="white-space: pre-wrap;">${result.aiFeedback}</p>
                </div>
            `;

        modal.show();
    }

    function nextProblem() {
        bootstrap.Modal.getInstance(document.getElementById('resultModal')).hide();

        if (currentIndex + 1 < problems.length) {
            displayProblem(currentIndex + 1);
        } else {
            completeChallenge();
        }
    }

    async function completeChallenge() {
        if (timerInterval) {
            clearInterval(timerInterval);
        }

        try {
            // ÏÑ∏ÏÖò ÏôÑÎ£å Ï≤òÎ¶¨
            await fetch(`/api/sessions/${sessionId}/complete`, {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                }
            });

            // ÏµúÏ¢Ö Í≤∞Í≥º ÌëúÏãú
            const correctCount = results.filter(r => r.isCorrect).length;
            const accuracy = (correctCount / results.length * 100).toFixed(1);

            const completeBody = document.getElementById('completeBody');
            completeBody.innerHTML = `
                    <div class="text-center mb-4">
                        <h3 class="mb-3">ÏµúÏ¢Ö Ï†êÏàò</h3>
                        <div style="font-size: 3rem; font-weight: bold; color: #667eea;">
                            ${correctCount}/${results.length}
                        </div>
                        <div class="mt-2">
                            <span class="badge bg-primary" style="font-size: 1.2rem;">Ï†ïÎãµÎ•† ${accuracy}%</span>
                        </div>
                    </div>
                    <div class="row text-center">
                        <div class="col">
                            <h5 class="text-success">${correctCount}</h5>
                            <small>Ï†ïÎãµ</small>
                        </div>
                        <div class="col">
                            <h5 class="text-danger">${results.length - correctCount}</h5>
                            <small>Ïò§Îãµ</small>
                        </div>
                    </div>
                `;

            const modal = new bootstrap.Modal(document.getElementById('completeModal'));
            modal.show();

        } catch (error) {
            console.error('ÏÑ∏ÏÖò ÏôÑÎ£å Ï≤òÎ¶¨ Ïã§Ìå®:', error);
        }
    }

    function getCategoryName(category) {
        const names = {
            'SPRING_CORE': 'Spring Core',
            'SPRING_BOOT': 'Spring Boot',
            'SPRING_MVC': 'Spring MVC',
            'SPRING_DATA_JPA': 'Spring Data JPA',
            'SPRING_SECURITY': 'Spring Security'
        };
        return names[category] || category;
    }

    function getDifficultyName(difficulty) {
        const names = {
            'BEGINNER': 'Ï¥àÍ∏â',
            'INTERMEDIATE': 'Ï§ëÍ∏â',
            'ADVANCED': 'Í≥†Í∏â'
        };
        return names[difficulty] || difficulty;
    }

    function getTypeName(type) {
        const names = {
            'MULTIPLE_CHOICE': 'Í∞ùÍ¥ÄÏãù',
            'SHORT_ANSWER': 'Îã®ÎãµÌòï',
            'DESCRIPTIVE': 'ÏÑúÏà†Ìòï'
        };
        return names[type] || type;
    }

    document.addEventListener('DOMContentLoaded', loadSession);

    // ÌéòÏù¥ÏßÄ Ïù¥ÌÉà Í≤ΩÍ≥†
    window.addEventListener('beforeunload', function(e) {
        if (currentIndex < problems.length - 1) {
            e.preventDefault();
            e.returnValue = '';
        }
    });
</script>
</body>
</html>